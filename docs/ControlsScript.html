<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Controls Script</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
<div class="title">Controls Script</div><p>
<div class="toc">
<span class="toc-title">Contents</span>
<nav id="TOC">
<ul>
<li><a href="#overview">Overview</a><ul>
<li><a href="#applications">Applications</a></li>
<li><a href="#structure">Structure</a></li>
<li><a href="#simple-examples">Simple Examples</a></li>
</ul></li>
<li><a href="#slowpy-controls-library">SlowPy: Controls Library</a><ul>
<li><a href="#controls">Controls</a></li>
<li><a href="#database-interface">Database Interface</a></li>
<li><a href="#analysis-components">Analysis Components</a></li>
</ul></li>
<li><a href="#slowtask-slowdash-gui-script-interconnect">SlowTask: Slowdash GUI-Script Interconnect</a><ul>
<li><a href="#callback-functions-command-task">Callback Functions (Command Task)</a></li>
<li><a href="#thread-functions-routine-task">Thread Functions (Routine Task)</a></li>
<li><a href="#control-variable-binding">Control Variable Binding</a></li>
<li><a href="#listing-starting-stopping-and-reloading-the-slow-task-scripts">Listing, Starting, Stopping and Reloading the Slow-Task Scripts</a></li>
</ul></li>
</ul>
</nav>
</div>
</header>

<h1 id="overview">Overview</h1>
<h2 id="applications">Applications</h2>
<ul>
<li>Send commands and receive data to/from external systems (either software or hardware), including:
<ul>
<li>Another concurrent systems (DAQ system etc.)
<ul>
<li>Through a messaging system, such as Redis, AMQP, Kafka, ZMQ, …</li>
<li>Through a HTTP Get/Post, or Socket messages</li>
<li>By running a shell command</li>
</ul></li>
<li>Measurement devices that accept commands
<ul>
<li>SCPI measurement devices with ethernet interface</li>
<li>Anything that can be used from Python
<ul>
<li>Raspberry-Pi GPIO, I2C, SPI, …</li>
<li>USB devices with a vendor library</li>
</ul></li>
</ul></li>
<li>User analysis code that runs on streaming data</li>
</ul></li>
</ul>
<h2 id="structure">Structure</h2>
<p><img src="fig/ContrlScript-UserTask.png" width="40%"></p>
<ul>
<li>Controls are implemented as user task python script.</li>
<li>User task script is a normal Python script. Executable independently.</li>
<li>Panels on the Slowdash GUI, built by users, can call functions defined in user task scripts.</li>
<li>A Python library, <code>slowpy</code>, is provided to be imported by the user task scripts, for:
<ul>
<li>Simple unified methods to control external systems</li>
<li>Data classes such as histograms, graphs, time-series, etc.</li>
<li>Data storage interface to store the data objects, as well as raw data from the external systems</li>
</ul></li>
</ul>
<h2 id="simple-examples">Simple Examples</h2>
<h4 id="controlling-a-voltmeter-with-scpi-commands-over-ethernet">Controlling a voltmeter with SCPI commands over Ethernet</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">from</span> slowpy.control <span class="im">import</span> ControlSystem</a>
<a class="sourceLine" id="cb1-2" title="2">ctrl <span class="op">=</span> ControlSystem()</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co"># make a control node for a SCIP command of &quot;MEAS:V0&quot; on a device at 182.168.1.32</span></a>
<a class="sourceLine" id="cb1-5" title="5">V0 <span class="op">=</span> ctrl.ethernet(host<span class="op">=</span><span class="st">&#39;192.168.1.43&#39;</span>, port<span class="op">=</span><span class="dv">17674</span>).scpi(<span class="st">&#39;MEAS:V0&#39;</span>, set_format<span class="op">=</span><span class="st">&#39;V0 </span><span class="sc">{}</span><span class="st">;*OPC?&#39;</span>)</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co"># write a value to the control node: this will issue a SCPI command &quot;V0 10;*OPC?&quot;</span></a>
<a class="sourceLine" id="cb1-8" title="8">V0.<span class="bu">set</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="cf">while</span> <span class="va">True</span>:</a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="co"># read a value from the control node, with a SCPI command &quot;MEAS:V&quot;</span></a>
<a class="sourceLine" id="cb1-12" title="12">  value <span class="op">=</span> V0.get()</a>
<a class="sourceLine" id="cb1-13" title="13">  ...</a></code></pre></div>
<h4 id="writing-a-data-value-to-postgresql-database-using-a-default-schema">Writing a data value to PostgreSQL database (using a default schema)</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1"><span class="im">from</span> slowpy.store <span class="im">import</span> DataStore_PostgreSQL</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3">datastore <span class="op">=</span> DataStore_PostgreSQL(<span class="st">&#39;postgresql://postgres:postgres@localhost:5432/SlowTestData&#39;</span>, table<span class="op">=</span><span class="st">&quot;SlowData&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" title="4"></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="cf">while</span> <span class="va">True</span>:</a>
<a class="sourceLine" id="cb2-6" title="6">    value <span class="op">=</span> ...</a>
<a class="sourceLine" id="cb2-7" title="7">    datastore.append(value, tag<span class="op">=</span><span class="st">&quot;ch00&quot;</span>)</a></code></pre></div>
<h4 id="calling-a-user-task-function-from-slowdash-gui-panels">Calling a User Task function from SlowDash GUI Panels</h4>
<p>If you have a User Task Script like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">def</span> set_V0(value):</a>
<a class="sourceLine" id="cb3-2" title="2">    V0.<span class="bu">set</span>(value)</a></code></pre></div>
<p>and write a SlowDash HTML panel like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;form&gt;</span></a>
<a class="sourceLine" id="cb4-2" title="2">  V0: <span class="kw">&lt;input</span><span class="ot"> name=</span><span class="st">&quot;value&quot;</span><span class="kw">&gt;&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;test.set_V0()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>Then clicking the <code>Set</code> button will call the function <code>set_V0()</code> with a parameter in the <code>value</code> input field.</p>
<h4 id="displaying-the-readout-values-on-the-slowdash-panels">Displaying the readout values on the SlowDash panels</h4>
<p>For a control node <code>V0</code>, and <code>V1</code>, defining <code>_export()</code> function in the User Task Script will export these node values, making them available in SlowDash GUI in the same way as the values stored in database.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" title="1">V0 <span class="op">=</span> ctrl.ethernet(host<span class="op">=</span><span class="st">&#39;192.168.1.43&#39;</span>, port<span class="op">=</span><span class="dv">17674</span>).scpi(<span class="st">&#39;MEAS:V0&#39;</span>, set_format<span class="op">=</span><span class="st">&#39;V0 </span><span class="sc">{}</span><span class="st">;*OPC?&#39;</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">V1 <span class="op">=</span> ctrl.ethernet(host<span class="op">=</span><span class="st">&#39;192.168.1.43&#39;</span>, port<span class="op">=</span><span class="dv">17674</span>).scpi(<span class="st">&#39;MEAS:V1&#39;</span>, set_format<span class="op">=</span><span class="st">&#39;V1 </span><span class="sc">{}</span><span class="st">;*OPC?&#39;</span>)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">def</span> _export():</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="cf">return</span> [</a>
<a class="sourceLine" id="cb5-5" title="5">        (<span class="st">&#39;V0&#39;</span>, V0),</a>
<a class="sourceLine" id="cb5-6" title="6">        (<span class="st">&#39;V1&#39;</span>, Vi))</a>
<a class="sourceLine" id="cb5-7" title="7">    ]</a></code></pre></div>
<p>Only the “current” values are available in this way. If you need historical values, store the values in a database.</p>
<h1 id="slowpy-controls-library">SlowPy: Controls Library</h1>
<p>SlowPy is a Python library (module) that provides functions like:</p>
<ul>
<li>connecting external concurrent systems and/or measurement hardware</li>
<li>histograms, graphs, etc.</li>
<li>storing raw values, time-series and histograms/graphs to database in a way that SlowDash can easily handle.</li>
</ul>
<p>The SlowPy library is included in the SlowDash package, under <code>slowdash/lib/slowpy</code>. By running <code>source slowdash/bin/slowdash-bashrc</code>, as instructed in the Installation section, this path will be included in the environmental variable <code>PYTHONPAH</code>, so that users can use the library without modifying users system. It is also possible to install the library in a usual way: you can do <code>pip install slowdas/lib/slowpy</code> to install SlowPy into your Python environment. You might want to combine this with <code>pyenv</code> not to mess up your Python.</p>
<h2 id="controls">Controls</h2>
<p>SlowPy provides an unified interface to connect external software systems and hardware devices; everything will be mapped into a single “ControlTree” where each node has <code>set()</code> and <code>get()</code>. The tree represents logical structure of the system, for example, a SCPI command of <code>MEAS:V</code> to a voltmeter connected to an ethernet would be addressed like <code>ControlSystem.ethernet(host, port).scpi('MEAS:V')</code>, and <code>set(value)</code> to this node will send a SCPI command of <code>MEAS:V?</code> to the voltmeter. The <code>get()</code> method makes a read access and returns a value.</p>
<p>Plugin modules can dynamically add branches to the control tree. For example, Redis plugin adds the <code>redis()</code> node and a number of sub-branches for functions that Redis provides, such as hash, json and time-series. Plugins are loaded to a node, not (necessarily) to the root ControlSystem; for example, a plugin that uses ethernet is loaded to an ethernet node, creating a sub-branch under the ethernet node, and the plugin can make use of the function provided by the ethernet node such as <code>send()</code> (which is <code>set()</code> of the node) and <code>receive()</code> (which is <code>get()</code>).</p>
<h3 id="example">Example</h3>
<p>Here is an example of using SlowPy Controls. In this example, we use a power supply device that accepts the SCPI commands through ethernet.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1"><span class="im">from</span> slowpy.control <span class="im">import</span> ControlSystem</a>
<a class="sourceLine" id="cb6-2" title="2">ctrl <span class="op">=</span> ControlSystem()</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co"># make a control node for a SCIP command of &quot;MEAS:V0&quot; on a device at 182.168.1.32</span></a>
<a class="sourceLine" id="cb6-5" title="5">V0 <span class="op">=</span> ctrl.ethernet(host<span class="op">=</span><span class="st">&#39;192.168.1.43&#39;</span>, port<span class="op">=</span><span class="dv">17674</span>).scpi(<span class="st">&#39;MEAS:V0&#39;</span>, set_format<span class="op">=</span><span class="st">&#39;V0 </span><span class="sc">{}</span><span class="st">;*OPC?&#39;</span>)</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co"># write a value to the control node: this will issue a SCPI command &quot;V0 10;*OPC?&quot;</span></a>
<a class="sourceLine" id="cb6-8" title="8">V0.<span class="bu">set</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="cf">while</span> <span class="va">True</span>:</a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="co"># read a value from the control node, with a SCPI command &quot;MEAS:V&quot;</span></a>
<a class="sourceLine" id="cb6-12" title="12">  value <span class="op">=</span> V0.get()</a>
<a class="sourceLine" id="cb6-13" title="13">  ...</a></code></pre></div>
<p>A common start would be importing the <code>slowpy.control</code>, and then creating an instance of the <code>ControlSystem</code> class.</p>
<p>The <code>ControlSystem</code> already includes the <code>Ethernet</code> plugin, but if it were not, the loading plugin code would have been:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1">ctrl.load_control_module(<span class="st">&#39;Ethernet&#39;</span>)</a></code></pre></div>
<p>This will search for a file named <code>control_Ethernet.py</code> from search directories, load it, and inject the <code>ethernet()</code> Python method to the node class that loaded the plugin (which is ControlSystem in this case). The Ethernet plugin already includes sub-branches for SCPI; for specific protocols not already included, a plugin would be loaded onto the Ethernet node.</p>
<p>Each node constructor takes parameters. In this example, the ethernet node, which sends and receives data to/from the ethernet, takes the host/IP and port parameters, and a SCPI node, which is bound to a specific SCPI command, takes the SCPI command parameter with optional <code>set_format</code> which overrides the default SCPI command for writing. (The default SCPI command to be written/read <code>.scpi(CMD)</code> are <code>CMD</code> and <code>CMD?</code>, respectively. Often write operations should wait for the command completion, and SlowPy expects a return value from each command. A technique to do it, regardless to the actual command behaviors of the device, is to append <code>OPC?</code> to the command, as done in the example.)</p>
<p>Once you get the control node object, you can call <code>node.set(value)</code> to write the value, and call <code>value=node.get()</code> to read from it. As a shortcut, <code>node(value)</code> is equivalent to <code>node.set(value)</code>, and <code>value=node()</code> is equivalent to <code>value=node.get()</code>. Also control nodes define Python’s <code>__str__()</code>, <code>__float__()</code>, etc., so <code>print(node)</code> and <code>x = float(node)</code> will implicitly call <code>node.get()</code>.</p>
<h3 id="commonly-used-nodes">Commonly used nodes</h3>
<p>Naming convention: <code>set()</code>, <code>get()</code>, and <code>do_XXX()</code> are usual methods to do something. Methods with a noun name return a sub-node.</p>
<h4 id="ethenet-and-scpi">Ethenet and SCPI</h4>
<h5 id="loading">Loading</h5>
<p><code>ControlSystem.load_control_module('Ethernet')</code>: already included</p>
<h5 id="nodes">Nodes</h5>
<ul>
<li><strong>ethernet(host,port)</strong>: sends and receives text messages through a TCP socket connection
<ul>
<li>set(value): sends the value with adding a line delimiter (typically CR or LF)</li>
<li>get(): receives a line terminated by a line delimiter and returns it</li>
<li>do_flush(): empty the receiving buffer</li>
<li><strong>scpi(cmd)</strong> [sub-node]: issue a SCPI command via the parent ethernet connection
<ul>
<li>set(value): sends <code>cmd value</code> and waits for a reply</li>
<li>get(): sends <code>cmd?</code> and waits for a reply, then returns the reply</li>
</ul></li>
</ul></li>
</ul>
<h4 id="shell-command">Shell Command</h4>
<h5 id="loading-1">Loading</h5>
<p><code>ControlSystem.load_control_module('Shell')</code>: already included</p>
<h5 id="nodes-1">Nodes</h5>
<ul>
<li><strong>shell(cmd)</strong>: run a shell command.
<ul>
<li>set(*arg) launches <code>cmd arg</code>,</li>
<li>get() launches <code>cmd</code> and returns the result</li>
<li><strong>arg(*args)</strong>: append program arguments to the parent “shell” node. Example: <code>shell('read_adc', '--timeout=0').arg('--ch=0').get()</code></li>
</ul></li>
</ul>
<h4 id="redis-interface">Redis Interface</h4>
<h5 id="loading-2">Loading</h5>
<p><code>ControlSystem.load_control_module('Redis')</code></p>
<h5 id="nodes-2">Nodes</h5>
<ul>
<li><strong>redis(url)</strong>
<ul>
<li><strong>string(key)</strong>: read and write a simple key-value pair
<ul>
<li>set(value): writes a simple key-value pair</li>
<li>get(): returns a value of a simple key-value pair</li>
</ul></li>
<li><strong>hash(key)</strong>: read and write a map of key-value pairs
<ul>
<li>set(value): writes a map of key-value pairs</li>
<li>get(): returns a hash as a map of key-value pairs</li>
<li><strong>filed(name)</strong>:
<ul>
<li>set(value): writes a single element in the parent hash</li>
<li>get(): returns a single element value in the parent hash</li>
</ul></li>
</ul></li>
<li><strong>json(key)</strong>:
<ul>
<li>set(value): writes value (Python dict) to Redis JSON</li>
<li>get(): returns a Redis JSON as Python dict</li>
<li><strong>node(path)</strong>: read and write a branch of JSON object
<ul>
<li>set(value): writes value to a branch of Redis JSON</li>
<li>get(): returns a value of a branch of Redis JSON</li>
<li><strong>node(path)</strong>: can do this node iteration recursively</li>
</ul></li>
</ul></li>
<li><strong>ts(key)</strong>: read and write a time-series, where the value is a list of (t,x) tuples
<ul>
<li><strong>current()</strong>:
<ul>
<li>set(value): adds a data point to the parent time-series using the current time</li>
</ul></li>
<li><strong>last()</strong>:
<ul>
<li>get(): returns the last data point as a tuple of (t,x)</li>
<li><strong>value()</strong>:
<ul>
<li>get(): returns the value of the parent time-series point</li>
</ul></li>
<li><strong>time()</strong>:
<ul>
<li>get(): returns the UNIX time value of the parent time-series point</li>
</ul></li>
<li><strong>lapse()</strong>:
<ul>
<li>get(): returns the number of seconds since the last time-series point</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<h3 id="node-functions">Node Functions</h3>
<p>All the control nodes (derived from slowpy.control.ControlNode) have the following methods:</p>
<ul>
<li><strong>setpoint()</strong>: holds the setpoint
<ul>
<li>set(value): holds the value as a set-point, and calls <code>set(value)</code> of the parent node.</li>
<li>get(): returns the holding set-point value</li>
</ul></li>
<li><strong>ramping(change_per_sec)</strong>
<ul>
<li>set(value): starts ramping to the target value in the parent node</li>
<li>get(): returns parent’s <code>get()</code></li>
<li><strong>status()</strong>
<ul>
<li>set(value): <code>set(0)</code> will stop the current ramping if it is running</li>
<li>get(): returns <code>True</code> if rumping is in progress, otherwise returns <code>False</code></li>
</ul></li>
</ul></li>
<li>has_data(): returns True if a value is available for <code>get()</code></li>
<li>wait_until(condition_lambda, polling_interval=1, timeout=0): blocks until the condition_lambda returns True</li>
<li>sleep(duration_sec): blocks for the duration and returns True unless ControlSystem receives a stop request</li>
</ul>
<h2 id="database-interface">Database Interface</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1"><span class="im">import</span> time</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="im">from</span> slowpy.control <span class="im">import</span> DummyDevice_RandomWalk</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="im">from</span> slowpy.store <span class="im">import</span> DataStore_PostgreSQL</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">device <span class="op">=</span> DummyDevice_RandomWalk(n<span class="op">=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb8-6" title="6">datastore <span class="op">=</span> DataStore_PostgreSQL(<span class="st">&#39;postgresql://postgres:postgres@localhost:5432/SlowTestData&#39;</span>, table<span class="op">=</span><span class="st">&quot;Test&quot;</span>)</a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="cf">while</span> <span class="va">True</span>:</a>
<a class="sourceLine" id="cb8-9" title="9">    records <span class="op">=</span> { <span class="st">&#39;ch</span><span class="sc">%01d</span><span class="st">&#39;</span><span class="op">%</span>ch: device.read(ch) <span class="cf">for</span> ch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>) }</a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="bu">print</span>(records)</a>
<a class="sourceLine" id="cb8-11" title="11"></a>
<a class="sourceLine" id="cb8-12" title="12">    datastore.append(records)</a>
<a class="sourceLine" id="cb8-13" title="13">    </a>
<a class="sourceLine" id="cb8-14" title="14">    time.sleep(<span class="dv">1</span>)</a></code></pre></div>
<h2 id="analysis-components">Analysis Components</h2>
<p>SlowPy provides commonly used data objects such as histograms and graphs. These objects can be directly written to the database using the SlowPy Daabase Interface described above.</p>
<h3 id="histogram">Histogram</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1"><span class="im">import</span> slowpy <span class="im">as</span> slp</a>
<a class="sourceLine" id="cb9-2" title="2">hist <span class="op">=</span> slp.Histogram(<span class="dv">100</span>, <span class="dv">0</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4">device <span class="op">=</span> ...</a>
<a class="sourceLine" id="cb9-5" title="5">datastore <span class="op">=</span> ...</a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="cf">while</span> <span class="kw">not</span> ControlSystem.is_stop_requested():</a>
<a class="sourceLine" id="cb9-8" title="8">  value <span class="op">=</span> device.read(...</a>
<a class="sourceLine" id="cb9-9" title="9">  hist.fill(value)</a>
<a class="sourceLine" id="cb9-10" title="10">  data_store.write(hist, tag<span class="op">=</span><span class="st">&quot;test_hist&quot;</span>)</a></code></pre></div>
<h3 id="graph">Graph</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" title="1"><span class="im">import</span> slowpy <span class="im">as</span> slp</a>
<a class="sourceLine" id="cb10-2" title="2">graph <span class="op">=</span> slp.Graph([<span class="st">&#39;channel&#39;</span>, <span class="st">&#39;value&#39;</span>])</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="cf">while</span> <span class="kw">not</span> ControlSystem.is_stop_requested():</a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="cf">for</span> ch <span class="kw">in</span> <span class="bu">range</span>(n_ch):</a>
<a class="sourceLine" id="cb10-6" title="6">    value <span class="op">=</span> device.read(ch, ...</a>
<a class="sourceLine" id="cb10-7" title="7">    graph.fill(ch, value)</a>
<a class="sourceLine" id="cb10-8" title="8">  data_store.write(graph, tag<span class="op">=</span><span class="st">&quot;test_graph&quot;</span>)</a></code></pre></div>
<h3 id="trend">Trend</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" title="1"><span class="im">import</span> slowpy <span class="im">as</span> slp</a>
<a class="sourceLine" id="cb11-2" title="2">rate_trend <span class="op">=</span> slp.RateTrend(length<span class="op">=</span><span class="dv">300</span>, tick<span class="op">=</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="cf">while</span> <span class="kw">not</span> ControlSystem.is_stop_requested():</a>
<a class="sourceLine" id="cb11-5" title="5">  value <span class="op">=</span> device.read(...</a>
<a class="sourceLine" id="cb11-6" title="6">  rate_trend.fill(time.time())</a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8">  data_store.write(rate_trend.time_series(<span class="st">&#39;test_rate&#39;</span>))</a></code></pre></div>
<h1 id="slowtask-slowdash-gui-script-interconnect">SlowTask: Slowdash GUI-Script Interconnect</h1>
<p>SlowTask is a user Python script placed under the SlowDash config directory with a name like <code>slowtask-XXX.py</code>. SlowDash GUI can start/stop the script, call functions defined in the script, and bind control variables in the script to GUI elements. Using the SlowPy library from a SlowTask script is assumed for this design, but this is not a requirement.</p>
<h2 id="callback-functions-command-task">Callback Functions (Command Task)</h2>
<p>Functions in SlowTask scripts can be called from SlowDash GUI. If a script (of name <code>test</code>) has a function like this</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">def</span> destroy_apparatus():</a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="co">#... do your work here</span></a></code></pre></div>
<p>This can be called from SlowDash GUI in several ways.</p>
<p>From a HTML form panel in SlowPlot, clicking a <code>&lt;button&gt;</code> with a name of the task module and the function will call the function:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">&lt;form&gt;</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;test.set_V0()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>Here the parenthesis at the and of the button name indicates that this button is bound to a SlowTask function.</p>
<p>SlowTask functions can take parameters:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">def</span> set_V0(voltage, ramping):</a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="co">#... do your work here</span></a></code></pre></div>
<p>and these parameter values are taken from the form values (typically from <code>&lt;input&gt;</code> entries):</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">&lt;form&gt;</span></a>
<a class="sourceLine" id="cb15-2" title="2">  Voltage: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;voltage&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb15-3" title="3">  Ramping: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;ramping&quot;</span><span class="ot"> value=</span><span class="st">&quot;1&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;test.set_V0()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>It is possible to place multiple buttons in one form.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">&lt;form&gt;</span></a>
<a class="sourceLine" id="cb16-2" title="2">  Ramping: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;ramping&quot;</span><span class="ot"> value=</span><span class="st">&quot;1&quot;</span><span class="ot"> style=</span><span class="st">&quot;width:5em&quot;</span><span class="kw">&gt;</span>/sec</a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb16-4" title="4">  V0: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;V0&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;async test.set_V0()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb16-5" title="5">  V1: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;V1&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;async test.set_V1()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb16-6" title="6">  V2: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;V2&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;async test.set_V2()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb16-7" title="7">  V3: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;V3&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;async test.set_V3()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set&quot;</span><span class="kw">&gt;&lt;br&gt;</span></a>
<a class="sourceLine" id="cb16-8" title="8">  <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb16-9" title="9">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;test.set_all()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Set All&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb16-10" title="10">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> name=</span><span class="st">&quot;async test.stop()&quot;</span><span class="ot"> value=</span><span class="st">&quot;Stop Ramping&quot;</span><span class="kw">&gt;&lt;br&gt;</span>    </a>
<a class="sourceLine" id="cb16-11" title="11"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>In that case, some input fields might not be used by some buttons. Since all the input field values are passed to the function parameters, it may cause a Python error of unexpected parameters. To absorb the unused parameters, a best practice is always adding <code>**kwargs</code> to the SlowTask function parameters:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">def</span> set_V0(V0, ramping, <span class="op">**</span>kwargs):</a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="co">#... do your work here</span></a></code></pre></div>
<p>In the example above, some functions have the <code>async</code> qualifier: by default, if a previous function call is in execution, a next action cannot be accepted to avoid multi-threading issues in the user code. The <code>async</code> qualifier indicates that this function call can be run in parallel to others. Another common qualifier is <code>await</code>, which instruct the GUI to wait for completion of the function execution before doing any other things (therefore it will look frozen).</p>
<p>The canvas panel can have a form to do the same as the HTML form panel. See the UI Panels section for details.</p>
<h2 id="thread-functions-routine-task">Thread Functions (Routine Task)</h2>
<p>If a SlowTask script has functions of <code>_initialize(params)</code>, <code>_finalize()</code>, <code>_run()</code>, and/or <code>_loop()</code>, one dedicated thread will be created and these function are called in a sequence:</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>function</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>_initialize(params)</code></td>
<td>called once when the script is loaded. The <code>params</code> values are given by the SlowDash configuration.</td>
</tr>
<tr class="even">
<td><code>_run()</code></td>
<td>called once after <code>_initialize()</code>. If <code>_run()</code> is defined, <code>_halt()</code> should be also defined to stop the <code>_run()</code> function. <code>_halt()</code> will be called by SlowDash when the user stops the system.</td>
</tr>
<tr class="odd">
<td><code>_loop()</code></td>
<td>called repeatedly after <code>_initialize()</code>, until the user stops the system. To control the intervals, the function usually contains <code>time.sleep()</code> or equivalent.</td>
</tr>
<tr class="even">
<td><code>_finalize()</code></td>
<td>called once after <code>_run()</code> or <code>_loop()</code></td>
</tr>
</tbody>
</table>
<h2 id="control-variable-binding">Control Variable Binding</h2>
<p>Control variables (instances of the Control Node classes) can be bound to GUI elements if a SlowTask script exports them with the <code>_export()</code> function:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">def</span> _export():</a>
<a class="sourceLine" id="cb18-2" title="2">    <span class="cf">return</span> [</a>
<a class="sourceLine" id="cb18-3" title="3">      (<span class="st">&#39;V0&#39;</span>, V0),</a>
<a class="sourceLine" id="cb18-4" title="4">      (<span class="st">&#39;V1&#39;</span>, V1),</a>
<a class="sourceLine" id="cb18-5" title="5">      (<span class="st">&#39;V2&#39;</span>, V2),</a>
<a class="sourceLine" id="cb18-6" title="6">      (<span class="st">&#39;V3&#39;</span>, V3)</a>
<a class="sourceLine" id="cb18-7" title="7">    ]</a></code></pre></div>
<p>Here the return value is a list of tuples of (name, control_node_variable). In the GUI, the exported entries can be used in the same way as data from a database. To export a variable that is not a control node, wrapping it with a control node is easy:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">class</span> RampingStatusNode(ControlNode):</a>
<a class="sourceLine" id="cb19-2" title="2">    <span class="kw">def</span> get(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb19-3" title="3">        <span class="cf">return</span> {</a>
<a class="sourceLine" id="cb19-4" title="4">            <span class="st">&#39;columns&#39;</span>: [ <span class="st">&#39;Channel&#39;</span>, <span class="st">&#39;Value&#39;</span>, <span class="st">&#39;Ramping&#39;</span> ],</a>
<a class="sourceLine" id="cb19-5" title="5">            <span class="st">&#39;table&#39;</span>: [</a>
<a class="sourceLine" id="cb19-6" title="6">                [ <span class="st">&#39;Ch0&#39;</span>, <span class="bu">float</span>(V0), <span class="st">&#39;Yes&#39;</span> <span class="cf">if</span> V0.ramping().status().get() <span class="cf">else</span> <span class="st">&#39;No&#39;</span> ],</a>
<a class="sourceLine" id="cb19-7" title="7">                [ <span class="st">&#39;Ch1&#39;</span>, <span class="bu">float</span>(V1), <span class="st">&#39;Yes&#39;</span> <span class="cf">if</span> V1.ramping().status().get() <span class="cf">else</span> <span class="st">&#39;No&#39;</span> ],</a>
<a class="sourceLine" id="cb19-8" title="8">                [ <span class="st">&#39;Ch2&#39;</span>, <span class="bu">float</span>(V2), <span class="st">&#39;Yes&#39;</span> <span class="cf">if</span> V2.ramping().status().get() <span class="cf">else</span> <span class="st">&#39;No&#39;</span> ],</a>
<a class="sourceLine" id="cb19-9" title="9">                [ <span class="st">&#39;Ch3&#39;</span>, <span class="bu">float</span>(V3), <span class="st">&#39;Yes&#39;</span> <span class="cf">if</span> V3.ramping().status().get() <span class="cf">else</span> <span class="st">&#39;No&#39;</span> ]</a>
<a class="sourceLine" id="cb19-10" title="10">            ]</a>
<a class="sourceLine" id="cb19-11" title="11">        }</a>
<a class="sourceLine" id="cb19-12" title="12">    </a>
<a class="sourceLine" id="cb19-13" title="13"><span class="kw">def</span> _export():</a>
<a class="sourceLine" id="cb19-14" title="14">    <span class="cf">return</span> [</a>
<a class="sourceLine" id="cb19-15" title="15">        (<span class="st">&#39;V0&#39;</span>, V0),</a>
<a class="sourceLine" id="cb19-16" title="16">        (<span class="st">&#39;V1&#39;</span>, V1),</a>
<a class="sourceLine" id="cb19-17" title="17">        (<span class="st">&#39;V2&#39;</span>, V2),</a>
<a class="sourceLine" id="cb19-18" title="18">        (<span class="st">&#39;V3&#39;</span>, V3),</a>
<a class="sourceLine" id="cb19-19" title="19">        (<span class="st">&#39;Status&#39;</span>, StatusNode())</a>
<a class="sourceLine" id="cb19-20" title="20">    ]</a></code></pre></div>
<p>Here the new node <code>StatusNode</code> returns a table object.</p>
<h2 id="listing-starting-stopping-and-reloading-the-slow-task-scripts">Listing, Starting, Stopping and Reloading the Slow-Task Scripts</h2>
<p>All SlowTask scripts (python file placed under project configuration directory with a name of <code>slowtask-XXX.py</code>) are automatically listed in the SlowDash Task Manager. Here users can manually start and stop the script. Starting again will reload the script.</p>
<p>Scripts can be started automatically, by making an entry in the <code>SlowdashProject.yaml</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb20-1" title="1"><span class="fu">slowdash_project:</span></a>
<a class="sourceLine" id="cb20-2" title="2">  ...</a>
<a class="sourceLine" id="cb20-3" title="3"></a>
<a class="sourceLine" id="cb20-4" title="4">  <span class="fu">task:</span></a>
<a class="sourceLine" id="cb20-5" title="5">    <span class="fu">name:</span><span class="at"> test</span></a>
<a class="sourceLine" id="cb20-6" title="6">    <span class="fu">auto_load:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb20-7" title="7">    <span class="fu">parameters:</span></a>
<a class="sourceLine" id="cb20-8" title="8">      <span class="fu">default_ramping_speed:</span><span class="at"> </span><span class="fl">0.1</span></a>
<a class="sourceLine" id="cb20-9" title="9"></a>
<a class="sourceLine" id="cb20-10" title="10">  <span class="fu">system:</span></a>
<a class="sourceLine" id="cb20-11" title="11">    <span class="fu">our_security_is_perfect:</span><span class="at"> </span><span class="ch">false</span></a></code></pre></div>
<p>In the Slowdash configuration you can also pass parameters to the <code>_initialize()</code> function.</p>
<p>By setting <code>system/our_security_is_peferct</code> to <code>true</code> will enable editing of the Python scripts on the SlowDash web page. While this is convenient, be aware what this means. Python scripts can do anything, such as <code>system("rm *")</code>. Enable this feature only when the access is strictly controlled. Some careful systems run processes only in Docker containers, where the container system runs on a virtual machine (in case the container is cracked) inside a firewall.</p>


</body>
</html>
